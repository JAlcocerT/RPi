---
title: RPi IoT Project - Temperature and Humidity with DHT11 & InfluxDB
author: JAlcocerT
date: 2023-07-20 14:10:00 +0800
categories: [IoT & Data Analytics]
tags: [Sensors,Python,InfluxDB]
render_with_liquid: false
---

## Raspberry Pi and DHT11 Sensor

If you already have a RPi at home and a DHT11 sensor, you can perfectly get started with this project.

We are going to read Temperature and Humidity data from the sensor, save it into an InfluxDB (*say Hi to time-series DBs*) and display the output in Grafana (*Because terminal is great, but we want to make a cool end to end project*).

And docker? yes, let's put everything together and create a reliable Stack that we can share across any other RPi and forget about dependencies. Lets get started.

**We can use Raspberry Pi 32/64 bits for this project.**


## The Base Code: Python


Credits to <https://www.thegeekpub.com/236867/using-the-dht11-temperature-sensor-with-the-raspberry-pi/> for the initial scheleton of the code.

I have adapted it so that instead of printing the values, it will push them to an InfluxDB that we are going to self-host as well.

```py
import Adafruit_DHT
import time
from influxdb import InfluxDBClient

DHT_SENSOR = Adafruit_DHT.DHT11
DHT_PIN = 4

# Configure InfluxDB connection
influx_client = InfluxDBClient(host='influxdb', port=8086)

# Try to create the database, or use it if it already exists
database_name = 'sensor_data'
existing_databases = influx_client.get_list_database()

if {'name': database_name} not in existing_databases:
    influx_client.create_database(database_name)
    print(f"Database '{database_name}' created.")

influx_client.switch_database(database_name)

while True:
    humidity, temperature = Adafruit_DHT.read(DHT_SENSOR, DHT_PIN)
    if humidity is not None and temperature is not None:
        data = [
            {
                "measurement": "dht_sensor",
                "tags": {},
                "time": time.strftime('%Y-%m-%dT%H:%M:%SZ'),
                "fields": {
                    "temperature": temperature,
                    "humidity": humidity
                }
            }
        ]
        influx_client.write_points(data)
        print("Data sent to InfluxDB")
    else:
        print("Sensor failure. Check wiring.")
    time.sleep(3)
```

You can give it a try to this version (that just prints the values) to know that everything works for you, or just go to the next step.


## Pushing Data from Python to InfluxDB

We will be using 2 existing containers:
* <https://hub.docker.com/_/influxdb/tags>
* <https://hub.docker.com/_/python>

We have 3 mandatory components for this to work:

* The adjusted Python code that pushed data: <https://github.com/JAlcocerT/RPi/Z_IoT/DHT11-to-InfluxDB/Python2InfluxDB.py>
* https://github.com/JAlcocerT/RPi/Z_IoT/DHT11-to-InfluxDB/Python2InfluxDB-Stack.yml
* The docker image that isolates all of this and allow us to deploy easier: <https://hub.docker.com/r/fossengineer/iot/tags>
    * The tag is: dht11_sensor_to_influxdb

And another one if you want to replicate the docker build process:

* The https://github.com/JAlcocerT/RPi/Z_IoT/DHT11-to-InfluxDB/Dockerfile>
## FAQ

### How can I Query InfluxDBs with SQL?


If you go inside the InfluxDB container, you can execute the following to check that everything is working as it should:

```sh
influx
show databases
use sensor_data
show measurements
```

Then, query your InfluxDB with:

```sql
SELECT * FROM dht_sensor
SELECT * FROM dht_sensor ORDER BY time DESC LIMIT 10
```

### Why priviledge flag?

The container needs access to the GPIO port, otherwise, you will observe this error in the container:


```sh
Traceback (most recent call last):

  File "dht11_python_timescale.py", line 34, in <module>

    humidity, temperature = Adafruit_DHT.read(DHT_SENSOR, DHT_PIN)

  File "/usr/local/lib/python3.8/site-packages/Adafruit_DHT/common.py", line 81, in read

    return platform.read(sensor, pin)

  File "/usr/local/lib/python3.8/site-packages/Adafruit_DHT/Raspberry_Pi_2.py", line 34, in read

    raise RuntimeError('Error accessing GPIO.')

RuntimeError: Error accessing GPIO.
```